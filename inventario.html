<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Almoxarifado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4A90E2; --secondary-color: #6c757d; --background-light: #f4f7f6;
            --card-background: #ffffff; --text-dark: #343a40; --text-muted: #868e96;
            --border-color: #e9ecef; --success-color: #5cb85c; --danger-color: #d9534f;
            --info-color: #5bc0de; --sheets-green: #188038;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--background-light); }
        .container { max-width: 1400px; } /* Aumentado para mais espaço */
        .card { border: none; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.07); }
        .card-header { background: linear-gradient(135deg, var(--primary-color), var(--info-color)); color: white; border-radius: 12px 12px 0 0; padding: 1.5rem; text-align: center; border-bottom: none; }
        .nav-tabs { border-bottom-color: var(--border-color); }
        .nav-link { color: var(--text-muted); font-weight: 500; border-radius: 8px 8px 0 0 !important; cursor: pointer; }
        .nav-link.active { color: var(--primary-color); background-color: var(--card-background); border-bottom: 3px solid var(--primary-color) !important; font-weight: 600; }
        .table-responsive { max-height: 65vh; overflow-y: auto; }
        .table thead { position: sticky; top: -1px; background-color: var(--background-light); z-index: 10; }
        .kpi-card { border: 1px solid var(--border-color); border-radius: 10px; padding: 1.5rem; text-align: center; background-color: #fff; }
        .kpi-card .value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
        .kpi-card .label { font-size: 1rem; color: var(--text-muted); font-weight: 500; }
        .status-select { border-radius: 6px; font-weight: 500; border-width: 2px; }
        .status-recebido { background-color: #e3f2fd; border-color: #90caf9; color: #0d6efd; }
        .status-em-separacao { background-color: #fff8e1; border-color: #ffe082; color: #f57f17; }
        .status-concluido { background-color: #e8f5e9; border-color: #a5d6a7; color: #1e8e3e; }
        .btn-sheets { background-color: var(--sheets-green); color: white; border-color: var(--sheets-green); }
        .btn-sheets:hover { background-color: #136c2e; border-color: #136c2e; }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="fas fa-chart-line"></i> Painel de Controle do Almoxarifado</h3>
                <div>
                    <a href="index.html" target="_blank" class="btn btn-light btn-sm"><i class="fas fa-edit"></i> Acessar Formulário</a>
                    <a href="https://docs.google.com/spreadsheets/d/1aOWeZYIo1Che6vlj7TPwasVcxmR97eeq83WsWsDtP_I/edit" target="_blank" class="btn btn-sheets btn-sm">
                        <i class="fas fa-table"></i> Acessar Planilha
                    </a>
                </div>
            </div>
            <div class="card-body p-4">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory-pane" type="button"><i class="fas fa-boxes"></i> Inventário</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button"><i class="fas fa-clipboard-list"></i> Gerenciar Pedidos</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-pane" type="button"><i class="fas fa-chart-pie"></i> Relatórios</button></li>
                </ul>
                <div class="tab-content pt-3" id="myTabContent">
                    <div class="tab-pane fade show active" id="inventory-pane" role="tabpanel">
                        <div class="d-flex justify-content-end align-items-center mb-3">
                            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addNewItemModal"><i class="fas fa-plus"></i> Novo Material</button>
                            <button class="btn btn-outline-secondary" onclick="fetchInventory()"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="inventory-display" class="table-responsive"></div>
                    </div>
                    <div class="tab-pane fade" id="orders-pane" role="tabpanel">
                        <div class="d-flex justify-content-end align-items-center mb-3">
                            <button class="btn btn-outline-secondary" onclick="fetchOrders()"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="orders-display" class="table-responsive"></div>
                    </div>
                    <div class="tab-pane fade" id="analytics-pane" role="tabpanel">
                        <div class="d-flex justify-content-end align-items-center mb-3"><button class="btn btn-outline-secondary" onclick="fetchAnalytics()"><i class="fas fa-sync-alt"></i> Atualizar Relatórios</button></div>
                        <div id="analytics-display"></div>
                    </div>
                </div>
                 <div id="loading" class="text-center p-5" style="display: none;"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Carregando...</p></div>
                 <div id="error-display" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addStockModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Item: <strong id="itemName"></strong></p><p>Estoque Atual: <strong id="currentStock"></strong></p><div class="mb-3"><label for="quantityToAdd" class="form-label">Quantidade a Adicionar:</label><input type="number" class="form-control" id="quantityToAdd" min="1" required></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="saveStockButton">Salvar</button></div></div></div></div>
    <div class="modal fade" id="addNewItemModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Adicionar Novo Material</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label for="newItemName" class="form-label">Nome do Novo Material:</label><input type="text" class="form-control" id="newItemName" required></div><div class="mb-3"><label for="initialQuantity" class="form-label">Quantidade Inicial:</label><input type="number" class="form-control" id="initialQuantity" min="0" value="0" required></div><div class="mb-3"><label for="itemCategory" class="form-label">Categoria:</label><select class="form-select" id="itemCategory" required><option value="" selected disabled>Selecione...</option><option>Material de Escritório</option><option>Material para Copa</option><option>Material de Limpeza</option></select></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="saveNewItemButton">Salvar Novo Material</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGhyNSo1-w9TDM4BmtkMWTn6bLdwbnkcupdr7i5zZaqD6nrcMnqvPnKncVn8_nSb3A/exec";
        const LOW_STOCK_THRESHOLD = 10;
        const HIGH_STOCK_THRESHOLD = 100;

        const loadingDiv = document.getElementById('loading'), errorDiv = document.getElementById('error-display'), addStockModal = new bootstrap.Modal(document.getElementById('addStockModal')), addNewItemModal = new bootstrap.Modal(document.getElementById('addNewItemModal'));
        const showLoading = (show) => { loadingDiv.style.display = show ? 'block' : 'none'; }; const showError = (message) => { errorDiv.textContent = message; errorDiv.style.display = 'block'; }; const hideMessages = () => { errorDiv.style.display = 'none'; };
        async function apiCall(page = null, payload = null) { hideMessages(); showLoading(true); const url = page ? `${SCRIPT_URL}?page=${page}` : SCRIPT_URL; const options = payload ? { method: 'POST', mode: 'cors', body: JSON.stringify(payload) } : { method: 'GET' }; try { const response = await fetch(url, options); if (!response.ok) throw new Error(`A comunicação com o servidor falhou: ${response.statusText}`); const data = await response.json(); if (data.error || data.result === 'error') throw new Error(data.error || data.message); return data; } catch (error) { showError(error.message); throw error; } finally { showLoading(false); } }
        async function fetchInventory() { try { const data = await apiCall('inventory'); document.getElementById('inventory-display').innerHTML = buildInventoryHtml(data); } catch (error) { console.error('Falha ao carregar inventário:', error); } }
        async function fetchOrders() { try { const data = await apiCall('orders'); document.getElementById('orders-display').innerHTML = buildOrdersHtml(data); } catch (error) { console.error('Falha ao carregar pedidos:', error); } }
        async function fetchAnalytics() { try { const data = await apiCall('analytics'); document.getElementById('analytics-display').innerHTML = buildAnalyticsHtml(data); } catch (error) { console.error('Falha ao carregar relatórios:', error); } }
        function buildInventoryHtml(data) { const sortedCategories = Object.keys(data).sort(); if (sortedCategories.length === 0) return '<p class="text-center text-muted p-4">Nenhum item.</p>'; let html = ''; sortedCategories.forEach(category => { html += `<h4 class="mt-2 text-secondary">${category}</h4><table class="table table-sm table-striped table-hover align-middle"><thead class="table-light"><tr><th style="width: 120px;">Código</th><th>Item</th><th style="width: 120px;">Estoque</th><th style="width: 180px;">Ações</th></tr></thead><tbody>`; const sortedItems = data[category].sort((a, b) => a.nome.localeCompare(b.nome)); sortedItems.forEach(item => { html += `<tr><td><strong>${item.sku}</strong></td><td>${item.nome}</td><td>${item.qtd}</td><td><div class="btn-group" role="group"><button class="btn btn-sm btn-outline-primary" onclick="openAddStockModal('${item.nome.replace(/'/g, "\\'")}', ${item.qtd})">Adicionar</button><button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.nome.replace(/'/g, "\\'")}')">Excluir</button></div></td></tr>`; }); html += '</tbody></table>'; }); return html; }
        function buildOrdersHtml(data) { let html = `<table class="table table-sm table-hover align-middle"><thead class="table-light"><tr><th style="width: 150px;">ID Pedido</th><th>Data</th><th>Solicitante</th><th>ID Funcional</th><th>Item (Qtd)</th><th style="width: 180px;">Status</th></tr></thead><tbody>`; if (!Array.isArray(data) || data.length === 0) { html += `<tr><td colspan="6" class="text-center text-muted p-4">Nenhum pedido encontrado.</td></tr>`; } else { data.forEach(order => { const orderDate = new Date(order.timestamp).toLocaleDateString('pt-BR'); let statusClass = {'Recebido':'status-recebido', 'Em separação':'status-em-separacao', 'Concluído':'status-concluido'}[order.status] || ''; html += `<tr><td><code>${order.pedidoId}</code></td><td>${orderDate}</td><td>${order.solicitante} (${order.setor})</td><td>${order.idFuncional || 'N/A'}</td><td>${order.item} (${order.qtd})</td><td><select class="form-select form-select-sm status-select ${statusClass}" onchange="updateStatus(this, '${order.pedidoId}')"><option value="Recebido" ${order.status === 'Recebido' ? 'selected' : ''}>Recebido</option><option value="Em separação" ${order.status === 'Em separação' ? 'selected' : ''}>Em separação</option><option value="Concluído" ${order.status === 'Concluído' ? 'selected' : ''}>Concluído</option></select></td></tr>`; }); } html += '</tbody></table>'; return html; }
        function buildAnalyticsHtml(data) { const renderList = (items, isTop, isHigh) => { if (!items || items.length === 0) return `<li class="list-group-item text-muted">Nenhum dado.</li>`; return items.map(item => `<li class="list-group-item d-flex justify-content-between align-items-center">${isTop ? item.name : item[0]} <span class="badge bg-${isHigh ? 'success' : (isTop ? 'primary' : 'danger')} rounded-pill">${isTop ? item.count : item[1]}</span></li>`).join(''); }; return `<div class="row g-4"><div class="col-md-4"><div class="kpi-card h-100"><div class="value">${data.ordersTodayCount}</div><div class="label">Pedidos Hoje</div></div></div><div class="col-md-4"><div class="kpi-card h-100"><div class="value">${data.pendingOrdersCount}</div><div class="label">Pedidos Pendentes</div></div></div><div class="col-md-4"><div class="kpi-card h-100"><div class="value text-danger">${data.lowStockItems.length}</div><div class="label">Itens com Estoque Baixo</div></div></div></div><div class="row g-4 mt-3"><div class="col-lg-4"><h5 class="mt-4">Mais Pedidos no Mês</h5><ul class="list-group">${renderList(data.mostRequestedMonth, true)}</ul></div><div class="col-lg-4"><h5 class="mt-4">Mais Pedidos na Semana</h5><ul class="list-group">${renderList(data.mostRequestedWeek, true)}</ul></div><div class="col-lg-4"><h5 class="mt-4">Mais Pedidos Hoje</h5><ul class="list-group">${renderList(data.mostRequestedDay, true)}</ul></div></div><div class="row g-4 mt-3"><div class="col-lg-6"><h5 class="mt-4">Itens com Estoque Baixo (&lt;= ${LOW_STOCK_THRESHOLD})</h5><ul class="list-group">${renderList(data.lowStockItems, false, false)}</ul></div><div class="col-lg-6"><h5 class="mt-4">Itens com Estoque Alto (&gt;= ${HIGH_STOCK_THRESHOLD})</h5><ul class="list-group">${renderList(data.highStockItems, false, true)}</ul></div></div>`; }
        async function updateStatus(selectElement, pedidoId) { const newStatus = selectElement.value; selectElement.className = 'form-select form-select-sm status-select '; if (newStatus === 'Recebido') selectElement.classList.add('status-recebido'); else if (newStatus === 'Em separação') selectElement.classList.add('status-em-separacao'); else if (newStatus === 'Concluído') selectElement.classList.add('status-concluido'); selectElement.disabled = true; try { await apiCall(null, { action: 'updateOrderStatus', pedidoId, newStatus }); } catch (error) { alert(`Erro: ${error.message}`); } finally { selectElement.disabled = false; } }
        let currentItemName = ''; function openAddStockModal(itemName, currentStock) { currentItemName = itemName; document.getElementById('modalTitle').textContent = `Adicionar Estoque para ${itemName}`; document.getElementById('itemName').textContent = itemName; document.getElementById('currentStock').textContent = currentStock; document.getElementById('quantityToAdd').value = ''; addStockModal.show(); }
        async function deleteItem(itemName) { if (!confirm(`Excluir "${itemName}"?`)) return; try { await apiCall(null, { action: 'deleteItem', itemName: itemName }); await fetchInventory(); } catch (error) { alert(`Erro: ${error.message}`); } }
        document.getElementById('saveStockButton').addEventListener('click', async (e) => { const btn = e.target; const quantityToAdd = parseInt(document.getElementById('quantityToAdd').value); if (!quantityToAdd || quantityToAdd <= 0) { alert('Quantidade inválida.'); return; } btn.disabled = true; btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`; try { await apiCall(null, { action: 'addStock', itemName: currentItemName, quantityToAdd: quantityToAdd }); addStockModal.hide(); await fetchInventory(); } catch (error) { alert(`Erro: ${error.message}`); } finally { btn.disabled = false; btn.innerHTML = 'Salvar'; } });
        document.getElementById('saveNewItemButton').addEventListener('click', async (e) => { const btn = e.target; const newItemName = document.getElementById('newItemName').value.trim(); const initialQuantity = parseInt(document.getElementById('initialQuantity').value); const category = document.getElementById('itemCategory').value; if (!newItemName || !category || initialQuantity < 0) { alert('Preencha todos os campos.'); return; } btn.disabled = true; btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`; try { await apiCall(null, { action: 'addNewItem', itemName: newItemName, initialQuantity: initialQuantity, category: category }); addNewItemModal.hide(); await fetchInventory(); } catch (error) { alert(`Erro: ${error.message}`); } finally { btn.disabled = false; btn.innerHTML = 'Salvar Novo Material'; } });
        document.addEventListener('DOMContentLoaded', () => { const tabs = document.querySelectorAll('#myTab button'); tabs.forEach(tab => tab.addEventListener('shown.bs.tab', (event) => { const targetId = event.target.id; if(targetId === 'inventory-tab') fetchInventory(); if(targetId === 'orders-tab') fetchOrders(); if(targetId === 'analytics-tab') fetchAnalytics(); })); fetchInventory(); });
    </script>
</body>
</html>
